FileName = "";
ИмяВременнойТаблицы = "Накладная_" + ЗАПРОС("SELECT SUSER_SNAME()");
ДескрипторФТП = -1;
НаличиеНакладных = true;

НомерТаблицы = -1;
НомерТаблицы = ТАБЛИЦАСОЗДАТЬ(ЗАПРОС("SELECT SUSER_SNAME()") + '_TempTable', 'FileName C(255)');

if(НомерТаблицы < 0)
{
	СООБЩЕНИЕ("Ошибка при создании таблицы.");
}

if(!ТАБЛИЦАПРИВЯЗАТЬПОЛЯ(НомерТаблицы, "*"))
{
	СООБЩЕНИЕ("Ошибка при привязке полей.");
}

ДескрипторФТП = ФТПСОЕДИНИТЬ(_АДРЕС_ФТП_СЕРВЕРА, _ЛОГИН_ФТП, _ПАРОЛЬ_ФТП, false);//соединение с ФТП

if(ФТПОШИБКА(ДескрипторФТП)) 
{
	СООБЩЕНИЕ(ФТПТЕКСТОШИБКИ(ДескрипторФТП), "Ошибка при подключении к серверу.");
}

if(!ФТПУСТАНОВИТЬКАТАЛОГ(ДескрипторФТП, _ВХОДЯЩИЕ_ДОКУМЕНТЫ_ФТП)) // переходим в папку INBOX
{
	СООБЩЕНИЕ("На сервере не найден каталог " + _ВХОДЯЩИЕ_ДОКУМЕНТЫ_ФТП, "Ошибка 1 ");
}

if(!ФТППОЛУЧИТЬФАЙЛПОШАБЛОНУ(ДескрипторФТП, _ШАБЛОН_ИМЕНИ_НАКЛАДНЫХ, _ПАПКА_ДЛЯ_НАКЛАДНЫХ)) // копируем все файлы по шаблону *.xml на локальный компьютер
{
	НаличиеНакладных = false;
}

if(!ФТПУДАЛИТЬФАЙЛ(ДескрипторФТП, _ШАБЛОН_ИМЕНИ_НАКЛАДНЫХ) && НаличиеНакладных) // после того как успешно нашли Файлы, можем смело удалять их с ФТП
{
	СООБЩЕНИЕ("Не удалось удалить файлы накладных с FTP сервера.", "Ошибка 1");
	return false;
}

if(!ФТПЗАКРЫТЬ(ДескрипторФТП)) // закрываем ФТП соединение
{
	СООБЩЕНИЕ("Не удалось закрыть соединение с FTP сервером.", "Предупреждение");
}

FileName = ФАЙЛВЫБРАТЬ(true, "Файлы накладных xml|" + _ШАБЛОН_ИМЕНИ_НАКЛАДНЫХ + "|Файлы загруженных накладных|*.downloaded", 4);

if(FileName == "" || ПУСТО(FileName))
{
	return false;
}

if (!ТАБЛИЦАДОБАВИТЬЗАПИСЬ(НомерТаблицы, "FileName"))
{
	СООБЩЕНИЕ("Ошибка при добавлении записи.");
}

if(!ТАБЛИЦАЗАКРЫТЬ(НомерТаблицы))
{
	СООБЩЕНИЕ("Ошибка при закрытии таблицы.");
}	

if(!ЗагрузитьНакладнуюЭДИ(FileName, ИмяВременнойТаблицы))
{
	СООБЩЕНИЕ("Ошибка при загрузке накладной.", "Ошибка 1");
	return false;
}

return ИмяВременнойТаблицы;