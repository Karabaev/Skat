#functionslib
#begin
#description Сервисные функции
#name Сервисные функции
#code 0000000002
#command INSERT INTO specfunctionslib (CODE,NAME,DESCRIPTION_,TEXT_,NOTE,F_LOCAL,GROUPNAME,FARC,UPDATED,RECEIVED,EDIT_DAT) VALUES ('----------','ЗапросТоваровИзХранилища','ЗАПРОСТОВАРОВИЗХРАНИЛИЩА (АДРЕССЕРВЕРА, ШК, ИМЯТАБЛИЦЫ, ТЕКСТОШИБКИ)','/##CHR(13)##/// Создаем временную таблицу, в которую будем собирать данные/##CHR(13)##/IF ( !ЗАПРОС( "CREATE TABLE " + ИМЯТАБЛИЦЫ + " ( prz int, value varchar( 512 ) DEFAULT '''', type_ varchar( 50 ) DEFAULT '''', rating int DEFAULT 0, date datetime DEFAULT GETDATE( ) )" ) )/##CHR(13)##/{/##CHR(13)##/	ТекстОшибки		= _ERRORDESCRIPTION;/##CHR(13)##/	RETURN false;/##CHR(13)##/}/##CHR(13)##//##CHR(13)##/// Выполняем команду GET с нужным URL/##CHR(13)##/ОтветСервера	= "";/##CHR(13)##/IF ( !Сервис.HTTPCommand( "GET", "/warebarcode?warebarcode=" + ШК, "", @ОтветСервера, "", АдресСервера ) ) RETURN false;/##CHR(13)##//##CHR(13)##/IF ( !ПУСТО( ОтветСервера ) )/##CHR(13)##/{/##CHR(13)##/	// Создаем временную таблицу с указанным именем и записываем в нее полученный ответ/##CHR(13)##/	ДОБАВИТЬКОНТЕКСТ( "SELECT * FROM " + ИМЯТАБЛИЦЫ, "ЛокальныйКонтекст" );/##CHR(13)##/	/##CHR(13)##/	ЗАГРУЗИТЬ( "ЛокальныйКонтекст", "XMLSTRING", ОтветСервера, "name", "", "names", "" );/##CHR(13)##/	REPLACE( "ЛокальныйКонтекст", "type_", "name", ''ALL'' );/##CHR(13)##/	ВЫГРУЗИТЬ( ИМЯТАБЛИЦЫ, "", "", "ЛокальныйКонтекст" );/##CHR(13)##/	УДАЛИТЬ( "ALL", "ЛокальныйКонтекст" );/##CHR(13)##/	/##CHR(13)##/	ЗАГРУЗИТЬ( "ЛокальныйКонтекст", "XMLSTRING", ОтветСервера, "shortname", "", "shortnames", "" );/##CHR(13)##/	REPLACE( "ЛокальныйКонтекст", "type_", "shortname", ''ALL'' );/##CHR(13)##/	ВЫГРУЗИТЬ( ИМЯТАБЛИЦЫ, "", "", "ЛокальныйКонтекст" );/##CHR(13)##/	УДАЛИТЬ( "ALL", "ЛокальныйКонтекст" );/##CHR(13)##//##CHR(13)##/	ЗАГРУЗИТЬ( "ЛокальныйКонтекст", "XMLSTRING", ОтветСервера, "ed", "", "eds", "" );/##CHR(13)##/	REPLACE( "ЛокальныйКонтекст", "type_", "ed", ''ALL'' );/##CHR(13)##/	ВЫГРУЗИТЬ( ИМЯТАБЛИЦЫ, "", "", "ЛокальныйКонтекст" );/##CHR(13)##/	УДАЛИТЬ( "ALL", "ЛокальныйКонтекст" );/##CHR(13)##//##CHR(13)##/	ЗАГРУЗИТЬ( "ЛокальныйКонтекст", "XMLSTRING", ОтветСервера, "article", "", "articles", "" );/##CHR(13)##/	REPLACE( "ЛокальныйКонтекст", "type_", "article", ''ALL'' );/##CHR(13)##/	ВЫГРУЗИТЬ( ИМЯТАБЛИЦЫ, "", "", "ЛокальныйКонтекст" );/##CHR(13)##/	УДАЛИТЬ( "ALL", "ЛокальныйКонтекст" );/##CHR(13)##//##CHR(13)##/	ЗАГРУЗИТЬ( "ЛокальныйКонтекст", "XMLSTRING", ОтветСервера, "brand", "", "brands", "" );/##CHR(13)##/	REPLACE( "ЛокальныйКонтекст", "type_", "brand", ''ALL'' );/##CHR(13)##/	ВЫГРУЗИТЬ( ИМЯТАБЛИЦЫ, "", "", "ЛокальныйКонтекст" );/##CHR(13)##/	УДАЛИТЬ( "ALL", "ЛокальныйКонтекст" );/##CHR(13)##//##CHR(13)##/	ЗАГРУЗИТЬ( "ЛокальныйКонтекст", "XMLSTRING", ОтветСервера, "country", "", "countries", "" );/##CHR(13)##/	REPLACE( "ЛокальныйКонтекст", "type_", "country", ''ALL'' );/##CHR(13)##/	ВЫГРУЗИТЬ( ИМЯТАБЛИЦЫ, "", "", "ЛокальныйКонтекст" );/##CHR(13)##/	УДАЛИТЬ( "ALL", "ЛокальныйКонтекст" );/##CHR(13)##/}/##CHR(13)##//##CHR(13)##/RETURN true;/##CHR(13)##/','Функция запрашивает информацию о штриховом коде с сервера хранилища товаров',0,'',0,0,0,'03.09.2018 16:34:50')
#command INSERT INTO specfunctionslib (CODE,NAME,DESCRIPTION_,TEXT_,NOTE,F_LOCAL,GROUPNAME,FARC,UPDATED,RECEIVED,EDIT_DAT) VALUES ('----------','HTTPConnect','ЛОКАЛЬНАЯ HTTPCONNECT (АДРЕССЕРВЕРА, ПОРТ, ВЕСТИЖУРНАЛ)','// Если не указаны параметры, то используем сохраненные ранее значения/##CHR(13)##/IF ( ПУСТО( АдресСервера ) )	RETURN false;/##CHR(13)##//##CHR(13)##/HTTPHostIP		= АдресСервера;/##CHR(13)##/ПозицияДТ		= AT( АдресСервера, ":" );	/##CHR(13)##/IF ( ПозицияДТ > 0 )/##CHR(13)##/{/##CHR(13)##/	HTTPHostIP	= ПОДСТРОКА( АдресСервера, 1, ПозицияДТ - 1 );/##CHR(13)##/	Порт		= ПОДСТРОКА( АдресСервера, ПозицияДТ + 1 );/##CHR(13)##/}/##CHR(13)##//##CHR(13)##/IF ( ПУСТО( Порт ) )	Порт	= 80;/##CHR(13)##/Порт			= VAL( Порт );/##CHR(13)##//##CHR(13)##/// Сохраняем на будущее поле загоовка Host/##CHR(13)##/HTTPPort		= Порт;/##CHR(13)##/HTTPHost		= HTTPHostIP + ":" + HTTPPort;/##CHR(13)##//##CHR(13)##/HTTPConnection	= СОКЕТСОЕДИНИТЬ( HTTPHostIP, HTTPPort, ВестиЖурнал );/##CHR(13)##/RETURN HTTPConnection >= 0;','Соединение с HTTP сервером, работающим по указанному адресу на указанном порту. Возвращает номер совета для даьнейшей работы',1,'HTTP',0,0,0,'03.09.2018 16:34:50')
#command INSERT INTO specfunctionslib (CODE,NAME,DESCRIPTION_,TEXT_,NOTE,F_LOCAL,GROUPNAME,FARC,UPDATED,RECEIVED,EDIT_DAT) VALUES ('----------','HTTPGet','ЛОКАЛЬНАЯ HTTPGET (MURL, ТЕКСТОШИБКИ)','// Отправляем серверу переданный запрос/##CHR(13)##/ТекстОшибки	= "";/##CHR(13)##/HTTPRequest	= "GET " + СЖАТЬПРОБЕЛЫ( mURL ) + " HTTP/1.1" + CHR( 13 ) + CHR( 10 ) + /##CHR(13)##/			  "Host: " + HTTPHost + CHR( 13 ) + CHR( 10 ) + /##CHR(13)##/			  "User-Agent: itida/3.0.0" + CHR( 13 ) + CHR( 10 ) + /##CHR(13)##/			  "Accept: */*"  + CHR( 13 ) + CHR( 10 ) + CHR( 13 ) + CHR( 10 );/##CHR(13)##/			  /##CHR(13)##/IF ( !СОКЕТПЕРЕДАТЬ( HTTPConnection, HTTPRequest ) ) /##CHR(13)##/{/##CHR(13)##/	ТекстОшибки		= _ERRORDESCRIPTION;/##CHR(13)##/	RETURN "";/##CHR(13)##/}/##CHR(13)##//##CHR(13)##/RETURN Сервис.HTTPServerResponse( @ТекстОшибки );/##CHR(13)##/','Выполнение HTTP запроса GET',1,'HTTP',0,0,0,'03.09.2018 16:34:50')
#command INSERT INTO specfunctionslib (CODE,NAME,DESCRIPTION_,TEXT_,NOTE,F_LOCAL,GROUPNAME,FARC,UPDATED,RECEIVED,EDIT_DAT) VALUES ('----------','HTTPPost','ЛОКАЛЬНАЯ HTTPPOST (MURL, СТРОКАДЛЯОТПРАВКИ, ТЕКСТОШИБКИ, ИМЯФАЙЛА)','// Отправляем серверу переданный запрос/##CHR(13)##/ТекстОшибки			= "";/##CHR(13)##/Граница				= "------------------------975764a1c0b00c61";/##CHR(13)##/СТРОКАДЛЯОТПРАВКИ	= "--" + Граница + CHR( 13 ) + CHR( 10 ) + "Content-Disposition: form-data; name=""xml_file""; filename=""" + ИМЯФАЙЛА + """" + CHR( 13 ) + CHR( 10 ) + /##CHR(13)##/														"Content-Type: application/xml" + CHR( 13 ) + CHR( 10 ) + CHR( 13 ) + CHR( 10 ) + СТРОКАДЛЯОТПРАВКИ + CHR( 13 ) + CHR( 10 ) + /##CHR(13)##/														"--" + Граница + "--" + CHR( 13 ) + CHR( 10 );/##CHR(13)##/HTTPRequest			= "POST " + СЖАТЬПРОБЕЛЫ( mURL ) + " HTTP/1.1" + CHR( 13 ) + CHR( 10 ) + /##CHR(13)##/					  "Host: " + HTTPHost + CHR( 13 ) + CHR( 10 ) + /##CHR(13)##/					  "User-Agent: itida/3.0.0" + CHR( 13 ) + CHR( 10 ) + /##CHR(13)##/					  "Accept: */*"  + CHR( 13 ) + CHR( 10 ) + /##CHR(13)##/					  "Content-Length: " + STR( ДЛИНА( СТРОКАДЛЯОТПРАВКИ ) ) + CHR( 13 ) + CHR( 10 ) +/##CHR(13)##/					  "Content-Type: multipart/form-data; boundary=" + Граница + CHR( 13 ) + CHR( 10 ) + CHR( 13 ) + CHR( 10 ) +  СТРОКАДЛЯОТПРАВКИ;/##CHR(13)##//##CHR(13)##/IF ( !СОКЕТПЕРЕДАТЬ( HTTPConnection, HTTPRequest ) ) /##CHR(13)##/{/##CHR(13)##/	ТекстОшибки		= _ERRORDESCRIPTION;/##CHR(13)##/	RETURN "";/##CHR(13)##/}/##CHR(13)##//##CHR(13)##/RETURN Сервис.HTTPServerResponse( @ТекстОшибки );/##CHR(13)##/','Функция отправляет указанный файл',1,'HTTP',0,0,0,'03.09.2018 16:34:50')
#command INSERT INTO specfunctionslib (CODE,NAME,DESCRIPTION_,TEXT_,NOTE,F_LOCAL,GROUPNAME,FARC,UPDATED,RECEIVED,EDIT_DAT) VALUES ('----------','HTTPDelete','ЛОКАЛЬНАЯ HTTPDELETE (MURL, ТЕКСТОШИБКИ)','// Отправляем серверу переданный запрос/##CHR(13)##/ТекстОшибки			= "";/##CHR(13)##/HTTPRequest			= "DELETE " + СЖАТЬПРОБЕЛЫ( mURL ) + " HTTP/1.1" + CHR( 13 ) + CHR( 10 ) + /##CHR(13)##/					  "Host: " + HTTPHost + CHR( 13 ) + CHR( 10 ) + /##CHR(13)##/					  "User-Agent: itida/3.0.0" + CHR( 13 ) + CHR( 10 ) + /##CHR(13)##/					  "Accept: */*"  + CHR( 13 ) + CHR( 10 ) + CHR( 13 ) + CHR( 10 );/##CHR(13)##//##CHR(13)##/IF ( !СОКЕТПЕРЕДАТЬ( HTTPConnection, HTTPRequest ) ) /##CHR(13)##/{/##CHR(13)##/	ТекстОшибки		= _ERRORDESCRIPTION;/##CHR(13)##/	RETURN "";/##CHR(13)##/}/##CHR(13)##//##CHR(13)##/RETURN Сервис.HTTPServerResponse( @ТекстОшибки );/##CHR(13)##//##CHR(13)##/','Отправка команды удаления ресурса на HTTP сервер',1,'HTTP',0,0,0,'03.09.2018 16:34:50')
#command INSERT INTO specfunctionslib (CODE,NAME,DESCRIPTION_,TEXT_,NOTE,F_LOCAL,GROUPNAME,FARC,UPDATED,RECEIVED,EDIT_DAT) VALUES ('----------','HTTPServerResponse','ЛОКАЛЬНАЯ HTTPSERVERRESPONSE (ТЕКСТОШИБКИ, ВРЕМЯОТВЕТА)','// Получаем от сервера ответ/##CHR(13)##/// Первой строкой идет ответ в формате Версия протокола и код ответа/##CHR(13)##/IF ( ПУСТО( ВремяОтвета ) ) ВремяОтвета	= 10;/##CHR(13)##//##CHR(13)##/ВремяОтвета			= VAL( ВремяОтвета );/##CHR(13)##/ВремяОтвета			= ВремяОтвета * 1000;/##CHR(13)##/HTTPResponse		= СОКЕТПОЛУЧИТЬ( HTTPConnection, CHR( 13 ) + CHR( 10 ), "S", ВремяОтвета );/##CHR(13)##/ТекстОшибки			= "";/##CHR(13)##//##CHR(13)##/IF ( UPPER( LEFT( HTTPResponse, 4 ) ) != "HTTP" )/##CHR(13)##/{/##CHR(13)##/	ТекстОшибки	= "Ответ сервера не был распознан";/##CHR(13)##/	RETURN "";/##CHR(13)##/}/##CHR(13)##/HTTPRCode	= ПОДСТРОКА( HTTPREsponse, 10, 3 );/##CHR(13)##/IF ( HTTPRCode == "100" )/##CHR(13)##/{/##CHR(13)##/	HTTPResponse= СОКЕТПОЛУЧИТЬ( HTTPConnection, CHR( 13 ) + CHR( 10 ), "S" );/##CHR(13)##/	HTTPResponse= СОКЕТПОЛУЧИТЬ( HTTPConnection, CHR( 13 ) + CHR( 10 ), "S" );/##CHR(13)##/	HTTPRCode	= ПОДСТРОКА( HTTPREsponse, 10, 3 );/##CHR(13)##/}/##CHR(13)##/// Ответ должен начинаться с 2, а остальное ошибки/##CHR(13)##/IF ( LEFT( HTTPRCode, 1 ) != "2" ) /##CHR(13)##/{/##CHR(13)##/	ТекстОшибки	= "Сервер вернул сообщение об ошибке " + HTTPRCode;/##CHR(13)##/}/##CHR(13)##//##CHR(13)##/Длина		= 0;/##CHR(13)##/HTTPResponse= СОКЕТПОЛУЧИТЬ( HTTPConnection, CHR( 13 ) + CHR( 10 ), "S" );/##CHR(13)##/WHILE ( !ПУСТО( HTTPResponse ) ) /##CHR(13)##/{/##CHR(13)##/	IF ( UPPER( LEFT( HTTPResponse, 15 ) ) == "CONTENT-LENGTH:" )/##CHR(13)##/		Длина	= VAL( SUBSTR( HTTPResponse, 16 ) );/##CHR(13)##/	ELSE IF ( UPPER( LEFT( HTTPResponse, 18 ) ) == "TRANSFER-ENCODING:" AND ( UPPER( ALLTRIM( SUBSTR( HTTPResponse, 19 ) ) ) == "CHUNKED") )/##CHR(13)##/		Длина	= -1;/##CHR(13)##/	HTTPResponse= СОКЕТПОЛУЧИТЬ( HTTPConnection, CHR( 13 ) + CHR( 10 ), "S" );/##CHR(13)##/}/##CHR(13)##/IF ( Длина > 0 )/##CHR(13)##/	HTTPResponse= СОКЕТПОЛУЧИТЬ( HTTPConnection, Длина, "S" );/##CHR(13)##/ELSE IF ( Длина < 0 )/##CHR(13)##/{/##CHR(13)##/	Длина		= ВЫЧИСЛИТЬ( "0x" + СОКЕТПОЛУЧИТЬ( HTTPConnection, CHR( 13 ) + CHR( 10 ), "S" ) );/##CHR(13)##/	HTTPResponse= "";/##CHR(13)##//##CHR(13)##/	WHILE ( Длина > 0 ) /##CHR(13)##/	{/##CHR(13)##/		HTTPResponse	+= СОКЕТПОЛУЧИТЬ( HTTPConnection, Длина, "S" );/##CHR(13)##/		// Далее обязательно пустая строка/##CHR(13)##/		СОКЕТПОЛУЧИТЬ( HTTPConnection, CHR( 13 ) + CHR( 10 ), "S" );/##CHR(13)##/		Длина			= ВЫЧИСЛИТЬ( "0x" + СОКЕТПОЛУЧИТЬ( HTTPConnection, CHR( 13 ) + CHR( 10 ), "S" ) );/##CHR(13)##/	}/##CHR(13)##/}/##CHR(13)##//##CHR(13)##/RETURN ЕСЛИ( !ПУСТО( ТекстОшибки ), "", HTTPResponse );/##CHR(13)##/','Получение ответа сервера на выполняемую операцию',1,'HTTP',0,0,0,'03.09.2018 16:34:50')
#command INSERT INTO specfunctionslib (CODE,NAME,DESCRIPTION_,TEXT_,NOTE,F_LOCAL,GROUPNAME,FARC,UPDATED,RECEIVED,EDIT_DAT) VALUES ('----------','HTTPCommand','ЛОКАЛЬНАЯ HTTPCOMMAND (КОМАНДА, MURL, СТРОКАДЛЯОТПРАВКИ, ОТВЕТСЕРВЕРА, ИМЯФАЙЛА, АДРЕССЕРВЕРА, ПОРТСЕРВЕРА)','ОтветСервера		= "";/##CHR(13)##/IF ( ПУСТО( АДРЕССЕРВЕРА ) ) АДРЕССЕРВЕРА = ЕСЛИ( ПУСТО( ПОРТСЕРВЕРА ), HTTPHost, HTTPHostIP );/##CHR(13)##//##CHR(13)##/IF ( !Сервис.HTTPConnect( АДРЕССЕРВЕРА, ПОРТСЕРВЕРА, true ) ) /##CHR(13)##/{/##CHR(13)##/	СООБЩЕНИЕ( "Не удалось подключиться к серверу. Проверьте параметры соединения (" + ALLTRIM( АДРЕССЕРВЕРА ) + ":" + ALLTRIM( ПОРТСЕРВЕРА ) + ")." );/##CHR(13)##/	RETURN false;/##CHR(13)##/}/##CHR(13)##//##CHR(13)##/СообщениеОбОшибке	= "";/##CHR(13)##/IF ( ALLTRIM( UPPER( Команда ) ) == "GET" )/##CHR(13)##/	ОтветСервера		= Сервис.HTTPGet( mURL, @СообщениеОбОшибке );/##CHR(13)##/ELSE IF ( ALLTRIM( UPPER( Команда ) ) == "POST" )/##CHR(13)##/	ОтветСервера		= Сервис.HTTPPost( mURL, СтрокаДляОтправки, @СообщениеОбОшибке, ИмяФайла );/##CHR(13)##/ELSE IF ( ALLTRIM( UPPER( Команда ) ) == "DELETE" )/##CHR(13)##/	ОтветСервера		= Сервис.HTTPDelete( mURL, @СообщениеОбОшибке );/##CHR(13)##/ELSE/##CHR(13)##/	СообщениеОбОшибке	= "Неизвестная команда " + Команда;/##CHR(13)##/	/##CHR(13)##/Сервис.HTTPDisconnect( );/##CHR(13)##//##CHR(13)##/// Если вернулся пустой ответ, то это означает ошибку/##CHR(13)##/IF ( ПУСТО( ОтветСервера ) )/##CHR(13)##/{/##CHR(13)##/	IF ( !ПУСТО( СообщениеОбОшибке ) )/##CHR(13)##/	{/##CHR(13)##/		ИмяОперации		= "загрузке";/##CHR(13)##/		IF ( ALLTRIM( UPPER( Команда ) ) == "POST" )/##CHR(13)##/		{/##CHR(13)##/			ИмяОперации	= "отправке";/##CHR(13)##/			/##CHR(13)##/			// Записываем отправляемый текст в журнал ошибок отправки/##CHR(13)##/			ФайлОшибки	= ФАЙЛОТКРЫТЬ( "httpposterror.log", 1, 1 );/##CHR(13)##/			ФАЙЛУСТАНОВИТЬУКАЗАТЕЛЬ( ФайлОшибки, 0, 0, 2 );/##CHR(13)##/			ФАЙЛЗАПИСАТЬСТРОКУ( ФайлОшибки, REPLICATE( "*", "80" ) );/##CHR(13)##/			ФАЙЛЗАПИСАТЬСТРОКУ( ФайлОшибки, TTOC( ДАТАВРЕМЯ( ) ) + ": " + ALLTRIM( АДРЕССЕРВЕРА ) + ":" + ALLTRIM( ПОРТСЕРВЕРА ) + mURL );/##CHR(13)##/			ФАЙЛЗАПИСАТЬСТРОКУ( ФайлОшибки, "Ответ УТМ: " + ПЕРЕКОДИРОВАТЬ( HTTPResponse, "UTF-8", "ANSI" ) );/##CHR(13)##/			ФАЙЛЗАПИСАТЬСТРОКУ( ФайлОшибки, СтрокаДляОтправки );/##CHR(13)##/			ФАЙЛЗАКРЫТЬ( ФайлОшибки );/##CHR(13)##/			/##CHR(13)##/			IF ( СООБЩЕНИЕ( "При " + ИмяОперации + " файла" + CHR( 13 ) + mURL + CHR( 13 ) + "сервер вернул собщение об ошибке." + CHR( 13 ) + CHR( 13 ) + СообщениеОбОшибке + CHR( 13 ) + ПЕРЕКОДИРОВАТЬ( HTTPResponse, "UTF-8", "ANSI" ) + CHR( 13 ) + CHR( 13 ) + "Показать отправляемый текст?", "Отправка документа", 4 ) == 6 )/##CHR(13)##/				СООБЩЕНИЕ( "URL: " + mURL + CHR( 13 ) + ПЕРЕКОДИРОВАТЬ( СтрокаДляОтправки, "UTF-8", "ANSI" ) );/##CHR(13)##/			RETURN false;/##CHR(13)##/		}/##CHR(13)##/		ELSE IF ( ALLTRIM( UPPER( Команда ) ) == "DELETE" )/##CHR(13)##/			ИмяОперации	= "удалении";/##CHR(13)##//##CHR(13)##/		СООБЩЕНИЕ( "При " + ИмяОперации + " файла" + CHR( 13 ) + mURL + CHR( 13 ) + "сервер вернул собщение об ошибке." + CHR( 13 ) + СообщениеОбОшибке + CHR( 13 ) + ПЕРЕКОДИРОВАТЬ( HTTPResponse, "UTF-8", "ANSI" ), "Загрузка документа" );/##CHR(13)##/		RETURN false;/##CHR(13)##/	}/##CHR(13)##/	// GET должен возвращать результат. Дргуие команды не обязательно/##CHR(13)##/	ELSE IF ( ALLTRIM( UPPER( Команда ) ) == "GET" )/##CHR(13)##/	{/##CHR(13)##/		СООБЩЕНИЕ( "Нет данных для загрузки. URL " + mURL, "Загрузка документа" );/##CHR(13)##/		RETURN false;/##CHR(13)##/	}/##CHR(13)##/}/##CHR(13)##//##CHR(13)##/RETURN true;','',1,'HTTP',0,0,0,'03.09.2018 16:34:50')
#command INSERT INTO specfunctionslib (CODE,NAME,DESCRIPTION_,TEXT_,NOTE,F_LOCAL,GROUPNAME,FARC,UPDATED,RECEIVED,EDIT_DAT) VALUES ('----------','HTTPDisconnect','ЛОКАЛЬНАЯ HTTPDISCONNECT ()','СОКЕТЗАКРЫТЬ( HTTPConnection );/##CHR(13)##/','Завершение соединения с HTTP сервером',1,'HTTP',0,0,0,'03.09.2018 16:34:50')
#command INSERT INTO specfunctionslib (CODE,NAME,DESCRIPTION_,TEXT_,NOTE,F_LOCAL,GROUPNAME,FARC,UPDATED,RECEIVED,EDIT_DAT) VALUES ('----------','ОбновлениеТоваровВХранилище','ОБНОВЛЕНИЕТОВАРОВВХРАНИЛИЩЕ (АДРЕССЕРВЕРА, ИМЯТАБЛИЦЫ, ТЕКСТОШИБКИ)','/##CHR(13)##/// Создаем временную таблицу, в которую будем собирать данные/##CHR(13)##/IF ( !ДОБАВИТЬКОНТЕКСТ( "SELECT f_delete, barcode, name, shortname, ed, article, brand, country FROM " + ИМЯТАБЛИЦЫ, "Данные" ) )/##CHR(13)##/{/##CHR(13)##/	ТекстОшибки		= _ERRORDESCRIPTION;/##CHR(13)##/	RETURN false;/##CHR(13)##/}/##CHR(13)##//##CHR(13)##/ПОКА ( !КОНЕЦКОНТЕКСТА( "Данные" ) )/##CHR(13)##/{/##CHR(13)##/	IF ( !ПУСТО( Данные.barcode ) )/##CHR(13)##/	{/##CHR(13)##/		СтрокаXML		= "<?xml version=""1.0"" encoding=""UTF-8""?>" + /##CHR(13)##/							Сервис.НепустойТЭГ( "name", Данные.name )   + Сервис.НепустойТЭГ( "shortname", Данные.shortname ) +/##CHR(13)##/							Сервис.НепустойТЭГ( "ed", Данные.ed )       + Сервис.НепустойТЭГ( "article", Данные.article ) +/##CHR(13)##/							Сервис.НепустойТЭГ( "brand", Данные.brand ) + Сервис.НепустойТЭГ( "country", Данные.country ) +/##CHR(13)##/							Сервис.НепустойТЭГ( "barcode", Данные.barcode );/##CHR(13)##/		/##CHR(13)##/		IF ( Данные.f_delete ) СтрокаXML	+= "<delete>1</delete>";/##CHR(13)##/			/##CHR(13)##/		// Выполняем команду POST с нужным URL/##CHR(13)##/		ОтветСервера	= "";/##CHR(13)##/		IF ( !Сервис.HTTPCommand( "POST", "/warebarcode", ПЕРЕКОДИРОВАТЬ( СтрокаXML, "ANSI", "UTF-8" ), @ОтветСервера, "", АдресСервера ) ) RETURN false;/##CHR(13)##/	}/##CHR(13)##/	ПРОПУСТИТЬ( 1, "Данные" );/##CHR(13)##/}/##CHR(13)##/УДАЛИТЬКОНТЕКСТ( "Данные" );/##CHR(13)##//##CHR(13)##/RETURN true;/##CHR(13)##/','Функция передает в хранилище команды удаления и добавления данных',0,'',0,0,0,'03.09.2018 16:34:50')
#command INSERT INTO specfunctionslib (CODE,NAME,DESCRIPTION_,TEXT_,NOTE,F_LOCAL,GROUPNAME,FARC,UPDATED,RECEIVED,EDIT_DAT) VALUES ('----------','ЗаменитьСимволы','ЗАМЕНИТЬСИМВОЛЫ (СТРОКА)','/##CHR(13)##/RETURN ЗАМЕНИТЬ( ЗАМЕНИТЬ( ЗАМЕНИТЬ( ЗАМЕНИТЬ( Строка, "&", "&amp;" ), "<", "&lt;" ), ">", "&gt;" ), """", "&quot;" );','',0,'',0,0,0,'03.09.2018 16:34:50')
#command INSERT INTO specfunctionslib (CODE,NAME,DESCRIPTION_,TEXT_,NOTE,F_LOCAL,GROUPNAME,FARC,UPDATED,RECEIVED,EDIT_DAT) VALUES ('----------','НепустойТЭГ','НЕПУСТОЙТЭГ (ТЭГ, ЗНАЧЕНИЕ)','/##CHR(13)##/RETURN ЕСЛИ( !ПУСТО( ЗНАЧЕНИЕ ), "<" + ТЭГ + ">" + Сервис.ЗаменитьСимволы( СЖАТЬПРОБЕЛЫ( ЗНАЧЕНИЕ ) ) + "</" + ТЭГ + ">", "" );','',0,'',0,0,0,'03.09.2018 16:34:50')
#command INSERT INTO specfunctionslib (CODE,NAME,DESCRIPTION_,TEXT_,NOTE,F_LOCAL,GROUPNAME,FARC,UPDATED,RECEIVED,EDIT_DAT) VALUES ('----------','ЗагрузкаEXCELCSV','ЗАГРУЗКАEXCELCSV ()','//загрузка параметров доступа к ФТП/##CHR(13)##//##CHR(10)##/PUBLIC ИмяФайла;/##CHR(13)##//##CHR(10)##//##CHR(13)##//##CHR(10)##/ИмяВременнойТаблицы = "Накладная";/##CHR(13)##//##CHR(10)##//##CHR(13)##//##CHR(10)##/ДескрипторФТП = -1;/##CHR(13)##//##CHR(10)##/ИмяФайла = "";/##CHR(13)##//##CHR(10)##/НаличиеНакладных = true;/##CHR(13)##//##CHR(10)##//##CHR(13)##//##CHR(10)##/	//соединение с ФТП/##CHR(13)##//##CHR(10)##/ДескрипторФТП = ФТПСОЕДИНИТЬ(_АДРЕС_ФТП_СЕРВЕРА, _ЛОГИН_ФТП, _ПАРОЛЬ_ФТП, false);/##CHR(13)##//##CHR(10)##//##CHR(13)##//##CHR(10)##///if(ДескрипторФТП == -1 || ДескрипторФТП == 0)/##CHR(13)##//##CHR(10)##///	СООБЩЕНИЕ("Ошибка при подключении к FTP серверу.", "Ошибка 1");/##CHR(13)##//##CHR(10)##//##CHR(13)##//##CHR(10)##/if(!ФТПОШИБКА(ДескрипторФТП)) /##CHR(13)##//##CHR(10)##/{/##CHR(13)##//##CHR(10)##/	СООБЩЕНИЕ(ФТПТЕКСТОШИБКИ(ДескрипторФТП), "Ошибка при подключении к серверу.");/##CHR(13)##//##CHR(10)##/}/##CHR(13)##//##CHR(10)##/	/##CHR(13)##//##CHR(10)##/if(!ФТПУСТАНОВИТЬКАТАЛОГ(ДескрипторФТП, _ВХОДЯЩИЕ_ДОКУМЕНТЫ_ФТП)) // переходим в папку INBOX/##CHR(13)##//##CHR(10)##/{/##CHR(13)##//##CHR(10)##/	СООБЩЕНИЕ("На сервере не найден каталог " + _ВХОДЯЩИЕ_ДОКУМЕНТЫ_ФТП, "Ошибка 1 ");/##CHR(13)##//##CHR(10)##/}/##CHR(13)##//##CHR(10)##//##CHR(13)##//##CHR(10)##///загрузка файлов с ФТП/##CHR(13)##//##CHR(10)##/if(!ФТППОЛУЧИТЬФАЙЛПОШАБЛОНУ(ДескрипторФТП, _ШАБЛОН_ИМЕНИ_НАКЛАДНЫХ, _ПАПКА_ДЛЯ_НАКЛАДНЫХ)) // копируем все файлы по шаблону *.xml на локальный компьютер/##CHR(13)##//##CHR(10)##/{/##CHR(13)##//##CHR(10)##/	//СООБЩЕНИЕ("В папке " + _ВХОДЯЩИЕ_ДОКУМЕНТЫ_ФТП + " не найдены файлы накладных.", "Предупреждение");/##CHR(13)##//##CHR(10)##/	НаличиеНакладных = false;/##CHR(13)##//##CHR(10)##/}/##CHR(13)##//##CHR(10)##////##CHR(13)##//##CHR(10)##/// Сделать дополнительную проверку перед удалением с ФТП на наличие файлов в локальной директории/##CHR(13)##//##CHR(10)##////##CHR(13)##//##CHR(10)##/if(!ФТПУДАЛИТЬФАЙЛ(ДескрипторФТП, _ШАБЛОН_ИМЕНИ_НАКЛАДНЫХ) && НаличиеНакладных) // после того как успешно нашли Файлы, можем смело удалять их с ФТП/##CHR(13)##//##CHR(10)##/{/##CHR(13)##//##CHR(10)##/	СООБЩЕНИЕ("Не удалось удалить файлы накладных с FTP сервера.", "Ошибка 1");/##CHR(13)##//##CHR(10)##/	return false;/##CHR(13)##//##CHR(10)##/}/##CHR(13)##//##CHR(10)##//##CHR(13)##//##CHR(10)##//##CHR(13)##//##CHR(10)##/if(!ФТПЗАКРЫТЬ(ДескрипторФТП)) // закрываем ФТП соединение/##CHR(13)##//##CHR(10)##/	СООБЩЕНИЕ("Не удалось закрыть соединение с FTP сервером.", "Предупреждение");/##CHR(13)##//##CHR(10)##//##CHR(13)##//##CHR(10)##/ИмяФайла = ФАЙЛВЫБРАТЬ(true, "Файлы накладных xml|" + _ШАБЛОН_ИМЕНИ_НАКЛАДНЫХ + "|Файлы загруженных накладных|*.downloaded", 4);/##CHR(13)##//##CHR(10)##/if(ИмяФайла == "" || ПУСТО(ИмяФайла))/##CHR(13)##//##CHR(10)##/	return false;/##CHR(13)##//##CHR(10)##/if(!ЗагрузитьНакладнуюЭДИ(ИмяФайла))/##CHR(13)##//##CHR(10)##/{/##CHR(13)##//##CHR(10)##/	СООБЩЕНИЕ("Ошибка при загрузке накладной.", "Ошибка 1");/##CHR(13)##//##CHR(10)##/	return false;/##CHR(13)##//##CHR(10)##/}/##CHR(13)##//##CHR(10)##/return ИмяВременнойТаблицы;','Загрузка накладных ТОРГР-12 из файлов формате XLSX и CSV',0,'',0,0,0,'03.09.2018 16:34:50')
#command INSERT INTO specfunctionslib (CODE,NAME,DESCRIPTION_,TEXT_,NOTE,F_LOCAL,GROUPNAME,FARC,UPDATED,RECEIVED,EDIT_DAT) VALUES ('----------','ЗагрузкаEXCELCSV_Копия','ЗАГРУЗКАEXCELCSV_КОПИЯ ()','ИмяФайла		= ФАЙЛВЫБРАТЬ( 1, "Файлы MS Excel|*.xlsx;*.csv" );/##CHR(13)##/IF ( ПУСТО( ИмяФайла ) ) RETURN REPLICATE( "-", 10 );/##CHR(13)##//##CHR(13)##/// Формируем таблицу из 100 полей для первоначальной загрузки данных/##CHR(13)##/ИмяВременнойТаблицы		= "##" + УНИКАЛЬНОЕИМЯ( );/##CHR(13)##/ВременныйКаталог		= ВРЕМЕННЫЙКАТАЛОГ( );/##CHR(13)##/СтрокаЗапроса			= "CREATE TABLE " + ИмяВременнойТаблицы + "( field0 varchar( 250 )";/##CHR(13)##/FOR ( index = 1; index < 100; index ++ )/##CHR(13)##/	СтрокаЗапроса		+= ",field" + STR( index ) + " varchar( 250 )";/##CHR(13)##//##CHR(13)##/СтрокаЗапроса		+= ")";/##CHR(13)##/ЗАПРОС( СтрокаЗапроса );/##CHR(13)##/ДОБАВИТЬКОНТЕКСТ( "SELECT * FROM " + ИмяВременнойТаблицы, "ЛокальныеДанные" );/##CHR(13)##/ЗАПРОС( "DROP TABLE " + ИмяВременнойТаблицы );/##CHR(13)##/	/##CHR(13)##/IF ( LOWER( ПРАВСИМВ( ИмяФайла, 4 ) ) == "xlsx" )/##CHR(13)##/{/##CHR(13)##/	// Преварительно удаляем разархивируемые файлы/##CHR(13)##/	ФАЙЛУДАЛИТЬ( ВременныйКаталог + "sheet1.xml" );/##CHR(13)##/	ФАЙЛУДАЛИТЬ( ВременныйКаталог + "SharedStrings.xml" );/##CHR(13)##//##CHR(13)##/	ВЫПОЛНИТЬ( "unzip.exe", "-C -j """ + ИмяФайла + """ xl\worksheets\sheet1.xml -d " + ВременныйКаталог, "", "open", 3 );/##CHR(13)##/	ВЫПОЛНИТЬ( "unzip.exe", "-C -j """ + ИмяФайла + """ xl\SharedStrings.xml -d " + ВременныйКаталог, "",  "open", 3 );/##CHR(13)##/	/##CHR(13)##/	IF ( !ФАЙЛ( ВременныйКаталог + "sheet1.xml" ) OR !ФАЙЛ( ВременныйКаталог + "SharedStrings.xml" ) )/##CHR(13)##/	{/##CHR(13)##/		СООБЩЕНИЕ( "Выбранный файл не является XLSX файлов. Выберите, пожалуйста, другой файл." );/##CHR(13)##/		RETURN REPLICATE( "-", 10 );/##CHR(13)##/	}/##CHR(13)##/	/##CHR(13)##/	// Необходимо загрузить список строк и значений в два курсора, затем перенести в общий курсор ЛокальныеДанные/##CHR(13)##/	ЗАПРОС( "CREATE TABLE " + ИмяВременнойТаблицы + "( r varchar( 250 ), v varchar( 250 ), t varchar( 250 )  )" );/##CHR(13)##/	ДОБАВИТЬКОНТЕКСТ( "SELECT * FROM " + ИмяВременнойТаблицы, "Строки" );/##CHR(13)##/	ЗАПРОС( "DROP TABLE " + ИмяВременнойТаблицы );/##CHR(13)##/	ЗАГРУЗИТЬ( "Строки", "XML", ВременныйКаталог + "sheet1.xml", "", "", "c" );/##CHR(13)##/	/##CHR(13)##/	ЗАПРОС( "CREATE TABLE " + ИмяВременнойТаблицы + "( t varchar( 250 ) )" );/##CHR(13)##/	ДОБАВИТЬКОНТЕКСТ( "SELECT * FROM " + ИмяВременнойТаблицы, "Значения" );0/##CHR(13)##/	ЗАПРОС( "DROP TABLE " + ИмяВременнойТаблицы );/##CHR(13)##/	ЗАГРУЗИТЬ( "Значения", "XML", ВременныйКаталог + "SharedStrings.xml", "si", "" );/##CHR(13)##/	/##CHR(13)##/	// Файлы более не нужны/##CHR(13)##/	ФАЙЛУДАЛИТЬ( ВременныйКаталог + "sheet1.xml" );/##CHR(13)##/	ФАЙЛУДАЛИТЬ( ВременныйКаталог + "SharedStrings.xml" );/##CHR(13)##//##CHR(13)##/	//Ф		= ФАЙЛСоздать( "D:\test.txt" );/##CHR(13)##/	ПЕРЕЙТИВНАЧАЛО( "Строки" );/##CHR(13)##/	WHILE ( !КОНЕЦКОНТЕКСТА( "Строки" ) )/##CHR(13)##/	{/##CHR(13)##/		НомерСимволаСтроки	= ЕСЛИ( ЯВЛЯЕТСЯЦИФРОЙ( ПОДСТРОКА( Строки.r, 2, 1 ) ), 2, 3 );/##CHR(13)##/		НомерКолонки		= ЛЕВСИМВ( Строки.r, НомерСимволаСтроки - 1 );/##CHR(13)##/		НомерСтроки			= VAL( ПОДСТРОКА( Строки.r, НомерСимволаСтроки ) );/##CHR(13)##/		НомерКолонки		= КОДСИМВОЛА( ПРОПИСНЫЕ( ПРАВСИМВ( НомерКолонки, 1 ) ) ) - КОДСИМВОЛА( "A" ) + ЕСЛИ( НомерСимволаСтроки == 3, ( КОДСИМВОЛА( ПРОПИСНЫЕ( ЛЕВСИМВ( НомерКолонки, 1 ) ) ) - КОДСИМВОЛА( "A" ) + 1 ) * 26, 0 );/##CHR(13)##/		//ФАЙЛЗАПИСАТЬСТРОКУ( Ф,  "r= " + Строки.r + "; НомерСимволаСтроки= " + НомерСимволаСтроки + "; НомерСтроки= " + НомерСтроки + "; НомерКолонки= " + НомерКолонки );/##CHR(13)##/		IF ( КОЛИЧЕСТВОСТРОК( "ЛокальныеДанные" ) < НомерСтроки )/##CHR(13)##/			ДОБАВИТЬСТРОКИ( НомерСтроки - КОЛИЧЕСТВОСТРОК( "ЛокальныеДанные" ), "ЛокальныеДанные" );/##CHR(13)##/		/##CHR(13)##/		ЗначениеПоля		= Строки.v;/##CHR(13)##/		IF ( Строки.t == "s" )/##CHR(13)##/		{/##CHR(13)##/			ПЕРЕЙТИ( VAL( Строки.v ), "Значения" );/##CHR(13)##/			ЗначениеПоля	= Значения.t;/##CHR(13)##/		}/##CHR(13)##/		ПЕРЕЙТИ( НомерСтроки - 1, "ЛокальныеДанные" );/##CHR(13)##/		ИЗМЕНИТЬПОЛЕ( "ЛокальныеДанные", НомерКолонки, ЗначениеПоля );/##CHR(13)##/		ПРОПУСТИТЬ( 1, "Строки" );/##CHR(13)##/	}/##CHR(13)##/	/##CHR(13)##/	/*ВЫБРАТЬКОНТЕКСТ( "ЛокальныеДанные" );/##CHR(13)##/	ПЕРЕЙТИВНАЧАЛО(  "ЛокальныеДанные" );/##CHR(13)##/	ПОКА ( !КОНЕЦКОНТЕКСТА( "ЛокальныеДанные" ) )/##CHR(13)##/	{/##CHR(13)##/		Строка		= ЗНАЧЕНИЕПОЛЯ( 0 );/##CHR(13)##/		FOR ( индекс = 1; индекс < 100; индекс++ )/##CHR(13)##/			Строка	+= ";" + ЗНАЧЕНИЕПОЛЯ( индекс );/##CHR(13)##/		ФАЙЛЗАПИСАТЬСТРОКУ( Ф,  Строка );/##CHR(13)##/		ПРОПУСТИТЬ( 1, "ЛокальныеДанные" );/##CHR(13)##/	}/##CHR(13)##/	ФАЙЛЗАКРЫТЬ( Ф );/##CHR(13)##/	*//##CHR(13)##/	/##CHR(13)##/	УДАЛИТЬКОНТЕКСТ( "Строки" );/##CHR(13)##/	УДАЛИТЬКОНТЕКСТ( "Значения" );/##CHR(13)##/}/##CHR(13)##/ELSE // Загружаем CSV в таблицу /##CHR(13)##/	ЗАГРУЗИТЬ( "ЛокальныеДанные", "csv", ИмяФайла, ";" );/##CHR(13)##//##CHR(13)##/// Создаем временную таблицу для сбора товаров/##CHR(13)##/ЗАПРОС( "CREATE TABLE " + ИмяВременнойТаблицы + "( npp varchar( 10 ), name varchar( 250 ), vendorware varchar( 250 ), ed varchar( 20 ), barcode varchar( 250 ), kolp float, cena float, summa float, sumnds float,/##CHR(13)##/												   vendor varchar( 250 ), vendorname varchar( 250 ), vendorinn varchar( 250 ), vendorkpp varchar( 250 ), vendorrs varchar( 250 ), vendorbik varchar( 250 ), /##CHR(13)##/												   vendoraddress varchar( 250 ), sklad varchar( 250 ), skladaddress varchar( 250 ), code char( 10 ), vendorndok varchar( 250 ), vendordate datetime, /##CHR(13)##/												   identity_column int IDENTITY( 1, 1 ) )" );/##CHR(13)##/ВЫБРАТЬКОНТЕКСТ( "ЛокальныеДанные" );/##CHR(13)##/ПЕРЕЙТИВНАЧАЛО( "ЛокальныеДанные" );/##CHR(13)##//##CHR(13)##/Грузополучатель			= "";/##CHR(13)##/Поставщик				= "";/##CHR(13)##/НомерНакладной			= "";/##CHR(13)##/ДатаНакладной			= "";/##CHR(13)##/Состояние				= 0;/##CHR(13)##/НомерПоля				= 0;/##CHR(13)##//##CHR(13)##/FOR ( локальный_индекс = 1; локальный_индекс <= 20; локальный_индекс++ ) ПОЛЕ[ локальный_индекс ]	= -1;/##CHR(13)##/// Сначала ищем грузополучателя и поставщика/##CHR(13)##/WHILE ( !КОНЕЦКОНТЕКСТА( "ЛокальныеДанные" ) && Состояние != 5 )/##CHR(13)##/{/##CHR(13)##/	Состояние			= 0;/##CHR(13)##/	НомерПоля			= 0;/##CHR(13)##/	FOR ( индекс = 0; индекс < 100; индекс++ )/##CHR(13)##/	{/##CHR(13)##/		ЗначениеПоля	= СЖАТЬПРОБЕЛЫ( ЗНАЧЕНИЕПОЛЯ( индекс ) );/##CHR(13)##/		IF ( Состояние == 0 AND ПРОПИСНЫЕ( ЗначениеПоля ) == "ПОСТАВЩИК" )/##CHR(13)##/			Состояние = 1;/##CHR(13)##/		ELSE IF ( Состояние == 0 AND ПРОПИСНЫЕ( ЗначениеПоля ) == "ГРУЗОПОЛУЧАТЕЛЬ" )/##CHR(13)##/			Состояние = 2;/##CHR(13)##/		ELSE IF ( Состояние == 0 AND ПРОПИСНЫЕ( ЗначениеПоля ) == "ТОВАРНАЯ НАКЛАДНАЯ" )/##CHR(13)##/			Состояние = 3;/##CHR(13)##/		ELSE IF ( Состояние == 0 AND ПРОПИСНЫЕ( ЗначениеПоля ) == "ВСЕГО ПО НАКЛАДНОЙ" )/##CHR(13)##/			Состояние = 5;/##CHR(13)##/		ELSE IF ( Состояние == 1 && !ПУСТО( ЗначениеПоля ) )/##CHR(13)##/		{/##CHR(13)##/			Поставщик	= ЗначениеПоля;/##CHR(13)##/			Состояние	= 0;/##CHR(13)##/		}/##CHR(13)##/		ELSE IF ( Состояние == 2 && !ПУСТО( ЗначениеПоля ) )/##CHR(13)##/		{/##CHR(13)##/			Грузополучатель	= ЗначениеПоля;/##CHR(13)##/			Состояние		= 0;/##CHR(13)##/		}/##CHR(13)##/		ELSE IF ( Состояние == 3 && !ПУСТО( ЗначениеПоля ) )/##CHR(13)##/		{/##CHR(13)##/			НомерНакладной	= ЗначениеПоля;/##CHR(13)##/			Состояние		= 4;	// Дата в этой же строке далее/##CHR(13)##/		}/##CHR(13)##/		ELSE IF ( Состояние == 4 && !ПУСТО( ЗначениеПоля ) )/##CHR(13)##/		{/##CHR(13)##/			ДатаНакладной	= ЗначениеПоля;/##CHR(13)##/			Состояние		= 0;	// В этой строке больше ничего нет/##CHR(13)##/		}/##CHR(13)##/		ELSE IF ( Состояние == 0 && !ПУСТО( ЗначениеПоля ) && VAL( ЗначениеПоля ) == НомерПоля + 1 )/##CHR(13)##/		{/##CHR(13)##/			НомерПоля++;/##CHR(13)##/			ПОЛЕ[ НомерПоля ]	= индекс;/##CHR(13)##/		}/##CHR(13)##/		ELSE IF ( Состояние == 0 && НомерПоля != 0 && !ПУСТО( ЗначениеПоля ) && НомерПоля < 15 )/##CHR(13)##/		{/##CHR(13)##/			// Если посчитали, что нашои подзаголовк таблицы с номерами поле, а встретилось инродное поле, то сбрасываем счетчик/##CHR(13)##/			НомерПоля			= 0;/##CHR(13)##/			FOR ( локальный_индекс = 1; локальный_индекс <= 20; локальный_индекс++ ) ПОЛЕ[ локальный_индекс ]	= -1;/##CHR(13)##/		}/##CHR(13)##/	}/##CHR(13)##/	// Нашли начало таблицы. Со следующей строки должны идти строки накладной/##CHR(13)##/	IF ( НомерПоля >= 15 )/##CHR(13)##/	{/##CHR(13)##/		ПРОПУСТИТЬ( 1, "ЛокальныеДанные" );/##CHR(13)##/		СТОП					= false;/##CHR(13)##/		WHILE ( !КОНЕЦКОНТЕКСТА( "ЛокальныеДанные" ) && !СТОП )/##CHR(13)##/		{/##CHR(13)##/			НомерПоПорядку		= ЗНАЧЕНИЕПОЛЯ( ПОЛЕ[ 1 ] );/##CHR(13)##/			НаименованиеТовара	= ЗНАЧЕНИЕПОЛЯ( ПОЛЕ[ 2 ] );/##CHR(13)##/			КодТовара			= ЗНАЧЕНИЕПОЛЯ( ПОЛЕ[ 3 ] );/##CHR(13)##/			ЕдиницаИзмерения	= ЗНАЧЕНИЕПОЛЯ( ПОЛЕ[ 4 ] );/##CHR(13)##/			Количество			= VAL( ЗАМЕНИТЬ( ЗАМЕНИТЬ( ЗНАЧЕНИЕПОЛЯ( ПОЛЕ[ 10 ] ), " ", "" ), CHR( 160 ), "" ) );/##CHR(13)##/			Сумма				= VAL( ЗАМЕНИТЬ( ЗАМЕНИТЬ( ЗНАЧЕНИЕПОЛЯ( ПОЛЕ[ 15 ] ), " ", "" ), CHR( 160 ), "" ) );/##CHR(13)##/			Цена				= Сумма / ЕСЛИ( Количество != 0, Количество, 1 );/##CHR(13)##/			СуммаНДС			= Сумма - VAL( ЗАМЕНИТЬ( ЗАМЕНИТЬ( ЗНАЧЕНИЕПОЛЯ( ПОЛЕ[ 12 ] ), " ", "" ), CHR( 160 ), "" ) );/##CHR(13)##/			ШтрихКод			= "";/##CHR(13)##/			IF ( ПОЛЕ[ 16 ] >= 0 )/##CHR(13)##/				ШтрихКод		= ЗНАЧЕНИЕПОЛЯ( ПОЛЕ[ 16 ] );/##CHR(13)##/			IF ( VAL( НомерПоПорядку ) != 0 )/##CHR(13)##/				ЗАПРОС( "INSERT INTO " + ИмяВременнойТаблицы + "( npp, name, vendorware, ed, kolp, cena, summa, sumnds, barcode )/##CHR(13)##/						 VALUES ( ''" + STDF( НомерПоПорядку ) + "'', ''" + STDF( НаименованиеТовара ) + "'', ''" + STDF( КодТовара ) + "'', ''" + STDF( ЕдиницаИзмерения ) + "'', " + /##CHR(13)##/									   STR( Количество, 20, 8 ) + ", " + STR( Цена, 20, 8 ) + ", " + STR( Сумма, 20, 8 ) + ", " + STR( СуммаНДС, 20, 8 ) + ", ''" + STDF( ШтрихКод ) + "'' )" );/##CHR(13)##/			ELSE/##CHR(13)##/				СТОП			= true;/##CHR(13)##/			// Добавляем запись /##CHR(13)##/			ПРОПУСТИТЬ( 1, "ЛокальныеДанные" );/##CHR(13)##/		}/##CHR(13)##/	}/##CHR(13)##/	ПРОПУСТИТЬ( 1, "ЛокальныеДанные" );/##CHR(13)##/}/##CHR(13)##///СООБЩЕНИЕ( НомерНакладной + " " + ДатаНакладной ); //+ " " + Грузополучатель + " " + Поставщик + " " + ИмяВременнойТаблицы );/##CHR(13)##/IF ( ПУСТО( CTOD( ДатаНакладной ) ) )/##CHR(13)##/	ДатаНакладной		= DTOC( ДОБАВИТЬДНИ( {01.01.1900}, VAL( ДатаНакладной ) - 2 ) );/##CHR(13)##/	/##CHR(13)##///СООБЩЕНИЕ( НомерНакладной + " " + ДатаНакладной ); //+ " " + Грузополучатель + " " + Поставщик + " " + ИмяВременнойТаблицы );/##CHR(13)##//##CHR(13)##/// Определяем поставщика/##CHR(13)##/// Ищем слово ИНН и берем набор цифр после этого слова/##CHR(13)##/ПоставщикНаименование	= "";/##CHR(13)##/ПоставщикИНН			= "";/##CHR(13)##/ПоставщикКПП			= "";/##CHR(13)##/ПоставщикАдрес			= "";/##CHR(13)##/ПоставщикРС				= "";/##CHR(13)##/ПоставщикБИК			= "";/##CHR(13)##//##CHR(13)##///Поставщик						= SUBSTR( Поставщик, AT( Поставщик, "ИНН" ) + 3 );/##CHR(13)##/// Пускаем пустые символы/##CHR(13)##/// Так немного дольше, но зато не привязываемся к символам разделителям ИНН и КПП (которого может и не быть)/##CHR(13)##///WHILE ( !ПУСТО( Поставщик ) AND LEFT( Поставщик, 1 ) <> "0" AND VAL( LEFT( Поставщик, 1 ) ) == 0 )/##CHR(13)##///	Поставщик	= SUBSTR( Поставщик, 2 );/##CHR(13)##/	/##CHR(13)##/Состояние				= 1;	/##CHR(13)##/WHILE ( !ПУСТО( Поставщик ) )/##CHR(13)##/{/##CHR(13)##/	ОдинСимвол			= ЛЕВСИМВ( Поставщик, 1 );/##CHR(13)##/	ТриСимвола			= ПРОПИСНЫЕ( ЛЕВСИМВ( Поставщик, 3 ) );/##CHR(13)##/	КоличествоСимволов	= 1;/##CHR(13)##/	IF ( ТриСимвола == "ИНН" )/##CHR(13)##/	{/##CHR(13)##/		Состояние			= 2;/##CHR(13)##/		КоличествоСимволов	= 3;/##CHR(13)##/	}/##CHR(13)##/	IF ( ТриСимвола == "КПП" )/##CHR(13)##/	{/##CHR(13)##/		Состояние			= 3;/##CHR(13)##/		КоличествоСимволов	= 3;/##CHR(13)##/	}/##CHR(13)##/	ELSE IF ( ТриСимвола == "Р/С" )/##CHR(13)##/	{/##CHR(13)##/		Состояние			= 4;/##CHR(13)##/		КоличествоСимволов	= 3;/##CHR(13)##/	}/##CHR(13)##/	ELSE IF ( ТриСимвола == "БИК" )/##CHR(13)##/	{/##CHR(13)##/		Состояние			= 5;/##CHR(13)##/		КоличествоСимволов	= 3;/##CHR(13)##/	}/##CHR(13)##/	ELSE IF ( Состояние == 1 AND ОдинСимвол == "," AND !ПУСТО( ПоставщикИНН ) )	// После названия может идти ИНН/КПП или адрес. Если ИНН уже был, то должен быть адрес. /##CHR(13)##/		Состояние	= 6;/##CHR(13)##/	ELSE IF ( Состояние == 1 AND ОдинСимвол == "," )/##CHR(13)##/		Состояние	= 0;/##CHR(13)##/	ELSE IF ( Состояние == 1 )/##CHR(13)##/		ПоставщикНаименование	+= ОдинСимвол;/##CHR(13)##/	ELSE IF ( Состояние == 6 )/##CHR(13)##/		ПоставщикАдрес	+= ОдинСимвол;/##CHR(13)##/	ELSE IF ( ВСПИСКЕ( Состояние, 2, 3, 4, 5, 20, 30, 40, 50 ) AND ЯВЛЯЕТСЯЦИФРОЙ( ОдинСимвол ) )/##CHR(13)##/	{/##CHR(13)##/		IF ( Состояние < 20  ) Состояние	*= 10 ;/##CHR(13)##/		IF ( Состояние == 20 ) ПоставщикИНН	+= ОдинСимвол;/##CHR(13)##/		IF ( Состояние == 30 ) ПоставщикКПП	+= ОдинСимвол;/##CHR(13)##/		IF ( Состояние == 40 ) ПоставщикРС	+= ОдинСимвол;/##CHR(13)##/		IF ( Состояние == 50 ) ПоставщикБИК	+= ОдинСимвол;/##CHR(13)##/	}/##CHR(13)##/	ELSE IF ( Состояние >= 20 AND ПУСТО( ПоставщикНаименование ) ) Состояние	= 1;/##CHR(13)##/	ELSE IF ( Состояние >= 20 AND ПУСТО( ПоставщикАдрес )  ) Состояние	= 6;/##CHR(13)##/	/##CHR(13)##/	Поставщик		= ПОДСТРОКА( Поставщик, КоличествоСимволов + 1 );/##CHR(13)##/}/##CHR(13)##//##CHR(13)##/ПоставщикНаименование	= СЖАТЬПРОБЕЛЫ( ПоставщикНаименование );/##CHR(13)##/ПоставщикАдрес			= СЖАТЬПРОБЕЛЫ( ПоставщикАдрес );/##CHR(13)##/IF ( ПРАВСИМВ( ПоставщикНаименование, 1 ) == "," )/##CHR(13)##/	ПоставщикАдрес		= СЖАТЬПРОБЕЛЫ( ЛЕВСИМВ( ПоставщикНаименование, ДЛИНА( ПоставщикНаименование ) - 1 ) );/##CHR(13)##/IF ( ПРАВСИМВ( ПоставщикАдрес, 1 ) == "," )/##CHR(13)##/	ПоставщикАдрес		= СЖАТЬПРОБЕЛЫ( ЛЕВСИМВ( ПоставщикАдрес, ДЛИНА( ПоставщикАдрес ) - 1 ) );/##CHR(13)##/IF ( ПРОПИСНЫЕ( ЛЕВСИМВ( ПоставщикАдрес, 5 ) ) == "АДРЕС" )/##CHR(13)##/	ПоставщикАдрес		= СЖАТЬПРОБЕЛЫ( ПОДСТРОКА( ПоставщикАдрес, 6 ) );/##CHR(13)##/IF ( ЛЕВСИМВ( ПоставщикАдрес, 1 ) == ":" )/##CHR(13)##/	ПоставщикАдрес		= СЖАТЬПРОБЕЛЫ( ПОДСТРОКА( ПоставщикАдрес, 2 ) );/##CHR(13)##//##CHR(13)##/// По ИНН определяем код поставщика/##CHR(13)##/Поставщик			= ЕСЛИ( ПУСТО( ПоставщикИНН ), "", ЗАПРОС( "SELECT code FROM sprclient WHERE inn= ''" + STDF( ПоставщикИНН ) + "'' " + ЕСЛИ( !ПУСТО( ПоставщикКПП ), " AND kpp = ''" + STDF( ПоставщикКПП ) + "''", "" ) ) );/##CHR(13)##/IF ( Поставщик AND !ПУСТО( ПоставщикИНН ) AND !ПУСТО( ПоставщикКПП ) )/##CHR(13)##/	Поставщик		= ЗАПРОС( "SELECT code FROM sprclient WHERE inn= ''" + STDF( ПоставщикИНН ) + "'' " );/##CHR(13)##/IF ( Поставщик AND !ПУСТО( ПоставщикНаименование ) )/##CHR(13)##/	Поставщик			= ЗАПРОС( "SELECT code FROM sprclient WHERE name= ''" + STDF( ПоставщикНаименование ) + "''" );/##CHR(13)##//##CHR(13)##/// Для определения склада используем следующий алгоритм/##CHR(13)##/// Сначала ищем название склада без пробелов в строке Грузополучатель./##CHR(13)##/Склад 				= ЗАПРОС( "SELECT code FROM sprskl WHERE CHARINDEX( REPLACE( RTRIM( name ), '' '', '''' ), ''" + STDF( STRTRAN( Грузополучатель, " " , "" ) ) + "'' ) > 0" );/##CHR(13)##/// Если склад не нашелся, то ищем его по наличию в поле грузополучатель в шапке эксель-документа обоих ключевых слов/##CHR(13)##/IF ( ПУСТО( Склад ) ) /##CHR(13)##/{/##CHR(13)##/	Склад 			= ЗАПРОС( "DECLARE @address varchar( 250 );/##CHR(13)##/							   SELECT @address= ''" + STDF( Грузополучатель ) + "'';/##CHR(13)##/							   SELECT code /##CHR(13)##/							   FROM sprskl /##CHR(13)##/							   WHERE CHARINDEX( SUBSTRING( ex_code, 1, CHARINDEX( '' '', RTRIM( ex_code ) ) ), @address ) > 0 AND/##CHR(13)##/									 CHARINDEX( LTRIM( RTRIM( SUBSTRING( ex_code, CHARINDEX( '' '', RTRIM( ex_code ) ), 50 ) ) ), /##CHR(13)##/									 SUBSTRING( @address, CHARINDEX( SUBSTRING( ex_code, 1, CHARINDEX( '' '', RTRIM( ex_code ) ) ), @address ) + LEN( SUBSTRING( ex_code, 1, CHARINDEX( '' '', RTRIM( ex_code ) ) ) ), 250 ) ) > 0" );/##CHR(13)##/}/##CHR(13)##//##CHR(13)##/// Записываем найденных поставщика и склад/##CHR(13)##/__SQL/##CHR(13)##/{/##CHR(13)##/	UPDATE temp /##CHR(13)##/	SET vendor			= ''[[STDF( Поставщик )]]'',/##CHR(13)##/		vendorName		= ''[[STDF( ПоставщикНаименование )]]'',/##CHR(13)##/		vendorAddress	= ''[[STDF( ПоставщикАдрес )]]'',/##CHR(13)##/		vendorINN		= ''[[STDF( ПоставщикИНН )]]'',/##CHR(13)##/		vendorKPP		= ''[[STDF( ПоставщикКПП )]]'',/##CHR(13)##/		vendorRS		= ''[[STDF( ПоставщикРС )]]'',/##CHR(13)##/		vendorBIK		= ''[[STDF( ПоставщикБИК )]]'',/##CHR(13)##/		sklad			= ''[[STDF( Склад )]]'',/##CHR(13)##/		skladaddress	= ''[[STDF( Грузополучатель )]]'',/##CHR(13)##/		vendorndok		= ''[[STDF( НомерНакладной )]]'',/##CHR(13)##/		vendordate		= ''[[DTOC( CTOD( ДатаНакладной ) )]]'',/##CHR(13)##/		code			= ''''/##CHR(13)##/	FROM [[ИмяВременнойТаблицы]] temp/##CHR(13)##/}/##CHR(13)##//##CHR(13)##/// Если удалось найти поставщика, то ищем в его кодах коды товаров/##CHR(13)##/__SQL/##CHR(13)##/{/##CHR(13)##/	UPDATE temp/##CHR(13)##/	SET code		= ISNULL( ( SELECT TOP 1 code FROM sprres_clients WHERE ex_code = temp.vendorware AND client= temp.vendor ), '''' )/##CHR(13)##/	FROM [[ИмяВременнойТаблицы]] temp /##CHR(13)##/	WHERE code = '''' AND vendor <> '''';/##CHR(13)##//##CHR(13)##/	UPDATE temp/##CHR(13)##/	SET code		= ISNULL( ( SELECT TOP 1 nn FROM sprnnbc WHERE bc = temp.barcode ), '''' )/##CHR(13)##/	FROM [[ИмяВременнойТаблицы]] temp /##CHR(13)##/	WHERE code = '''' AND barcode <> '''';/##CHR(13)##/}/##CHR(13)##//##CHR(13)##//*	UPDATE temp/##CHR(13)##/	SET code		= ISNULL( ( SELECT TOP 1 code FROM sprres WHERE ex_code = temp.vendorware AND cat = ''002'' ), '''' )/##CHR(13)##/	FROM [[ИмяВременнойТаблицы]] temp /##CHR(13)##/	WHERE code = '''';/##CHR(13)##//##CHR(13)##/	UPDATE temp/##CHR(13)##/	SET code		= ISNULL( ( SELECT TOP 1 code FROM sprres WHERE name = temp.name ), '''' )/##CHR(13)##/	FROM [[ИмяВременнойТаблицы]] temp /##CHR(13)##/	WHERE code = '''' AND name <> '''';/##CHR(13)##/*//##CHR(13)##//##CHR(13)##/RETURN ИмяВременнойТаблицы;/##CHR(13)##/','Загрузка накладных ТОРГР-12 из файлов формате XLSX и CSV',0,'',0,0,0,'03.09.2018 16:34:50')
#command INSERT INTO sprfunctionslib (CODE,NAME,ALIAS,F_SYSTEM,PARENT,FOLDER,POSORDER,MAINDB,MAINIC,CACCESS,TACCESS,NOTAVAIL,FARC,UPDATED,RECEIVED,EDIT_DAT) VALUES ('','Сервисные функции','Сервис',0,0.00000000,0,2.00000000,'',0.00000000,'','',0,0,1,0,'03.09.2018 16:34:50')
